(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const f=6,pt=4,yt=3;var u=(t=>(t[t.Empty=0]="Empty",t[t.X=1]="X",t[t.O=2]="O",t))(u||{}),E=(t=>(t[t.Ongoing=0]="Ongoing",t[t.XWins=1]="XWins",t[t.OWins=2]="OWins",t[t.Draw=3]="Draw",t))(E||{});function lt(){return new Array(f*f).fill(0)}function O(t){return t.filter(n=>n!==0).length%2===0?1:2}function R(t){const e=[];for(let n=0;n<t.length;n++)t[n]===0&&e.push(n);return e}function ct(t,e){if(t[e]!==0)throw new Error(`Cell ${e} is not empty`);const n=[...t];return n[e]=O(t),n}function vt(t){return[Math.floor(t/f),t%f]}function Et(t,e){return t*f+e}function tt(t,e,n,s,o,r){const l=[];let c=e,a=n;for(;c>=0&&c<f&&a>=0&&a<f;){const m=Et(c,a);if(t[m]===r)l.push(m),c+=s,a+=o;else break}return l}function at(t,e){const n=t.filter(m=>m!==0).length,s=n%2===1?1:2,[o,r]=vt(e),l=[[0,1],[1,0],[1,1],[1,-1]];let c=0,a=[];for(const[m,g]of l){const h=tt(t,o+m,r+g,m,g,s),I=[...tt(t,o-m,r-g,-m,-g,s).reverse(),e,...h];I.length>c&&(c=I.length,a=I)}return c>=pt?{result:s===1?1:2,winningIndices:a,losingIndices:[],losingPlayer:null}:c===yt?{result:(s===1?2:1)===1?1:2,winningIndices:[],losingIndices:a,losingPlayer:s}:n===f*f?{result:3,winningIndices:[],losingIndices:[],losingPlayer:null}:{result:0,winningIndices:[],losingIndices:[],losingPlayer:null}}const ut=u.Empty,x=[];function It(){for(let t=0;t<f;t++){const e=[];for(let n=0;n<f;n++)e.push(t*f+n);x.push(e)}for(let t=0;t<f;t++){const e=[];for(let n=0;n<f;n++)e.push(n*f+t);x.push(e)}for(let t=0;t<f;t++){const e=[];let n=0,s=t;for(;n<f&&s<f;)e.push(n*f+s),n++,s++;e.length>=3&&x.push(e)}for(let t=1;t<f;t++){const e=[];let n=t,s=0;for(;n<f&&s<f;)e.push(n*f+s),n++,s++;e.length>=3&&x.push(e)}for(let t=0;t<f;t++){const e=[];let n=f-1,s=t;for(;n>=0&&s<f;)e.push(n*f+s),n--,s++;e.length>=3&&x.push(e)}for(let t=f-2;t>=0;t--){const e=[];let n=t,s=0;for(;n>=0&&s<f;)e.push(n*f+s),n--,s++;e.length>=3&&x.push(e)}}It();function J(t,e,n){const s=[...t];s[e]=n;for(const o of x)if(o.includes(e))for(let r=0;r<=o.length-3;r++){const l=[o[r],o[r+1],o[r+2]];let c=0;for(const a of l)s[a]===n&&c++;if(c===3)return!0}return!1}function Z(t,e,n){const s=[...t];s[e]=n;for(const o of x)if(o.includes(e))for(let r=0;r<=o.length-4;r++){const l=[o[r],o[r+1],o[r+2],o[r+3]];let c=0;for(const a of l)s[a]===n&&c++;if(c===4)return!0}return!1}function Q(t,e){const n=new Set;for(const s of x)for(let o=0;o<=s.length-4;o++){const r=[s[o],s[o+1],s[o+2],s[o+3]];let l=0,c=-1,a=0;for(const m of r)t[m]===e?l++:t[m]===ut&&(a++,c=m);l===3&&a===1&&n.add(c)}return Array.from(n)}function Lt(t,e){const n=e===u.X?u.O:u.X,s=R(t);if(s.length===0)throw new Error("No legal moves available");for(const l of s)if(Z(t,l,e))return l;const o=Q(t,n),r=s.filter(l=>!J(t,l,e));if(o.length>0){const l=o.filter(c=>r.includes(c));if(l.length>0)return l[0]}return r.length>0?r[Math.floor(Math.random()*r.length)]:s[Math.floor(Math.random()*s.length)]}function ft(){return new URLSearchParams(window.location.search).get("rules")==="1"}function et(t,e,n){const s=[],o=[...t];o[e]=n;for(const r of x)if(r.includes(e))for(let l=0;l<=r.length-3;l++){const c=[r[l],r[l+1],r[l+2]];let a=0;for(const m of c)o[m]===n&&a++;a===3&&s.push(c)}return s}function nt(t,e,n){for(const s of x)if(s.includes(e))for(let o=0;o<=s.length-4;o++){const r=[s[o],s[o+1],s[o+2],s[o+3]];if(!r.includes(e))continue;let l=0,c=0;for(const a of r)t[a]===n?l++:t[a]===ut&&c++;if(l===3&&c===1)return r}return null}function dt(t,e){const n=e===u.X?u.O:u.X,s=R(t),o={isCheckmate:!1,loser:null,threatPatterns:[],suicidePatterns:[]};if(s.length===0)return o;for(const c of s)if(Z(t,c,e))return o;const r=Q(t,n),l=s.filter(c=>J(t,c,e));if(r.length>0){if(r.length>=2){const a=[];for(const m of r){const g=nt(t,m,n);g&&a.push(g)}return{isCheckmate:!0,loser:e,threatPatterns:a,suicidePatterns:[]}}const c=r.filter(a=>l.includes(a));if(c.length>0){const a=[],m=[];for(const g of c){const h=nt(t,g,n);h&&a.push(h);const w=et(t,g,e);m.push(...w)}return{isCheckmate:!0,loser:e,threatPatterns:a,suicidePatterns:m}}}if(l.length===s.length){const c=[];for(const a of l){const m=et(t,a,e);c.push(...m)}return{isCheckmate:!0,loser:e,threatPatterns:[],suicidePatterns:c}}return o}const bt={easy:3,medium:1.5,hard:1,expert:.1},xt={easy:2,medium:1,hard:.5,expert:0},Ot=20;function ht(t,e){const n=xt[e],s=t/36;return Math.max(0,1-s*n)}function Ct(t,e,n,s){const o=e===u.X?u.O:u.X,r=new Array(f*f).fill(0),l=ht(n,s),c=new Set(Q(t,o));for(let a=0;a<r.length;a++)if(t[a]===u.Empty){if(Z(t,a,e)){r[a]=1/0;continue}if(J(t,a,e)){r[a]=-1/0;continue}c.has(a)&&(r[a]=Ot*l)}return r}function k(t,e,n,s=1){const[o,r,l,c]=[t.length,t[0].length,t[0][0].length,t[0][0][0].length],[a,,m,g]=[e.length,e[0].length,e[0][0].length,e[0][0][0].length],h=l+2*s-m+1,w=c+2*s-g+1,I=[];for(let b=0;b<o;b++){I[b]=[];for(let y=0;y<a;y++){I[b][y]=[];for(let L=0;L<h;L++)I[b][y][L]=new Array(w).fill(n[y])}}for(let b=0;b<o;b++)for(let y=0;y<a;y++)for(let L=0;L<r;L++)for(let A=0;A<h;A++)for(let W=0;W<w;W++)for(let B=0;B<m;B++)for(let N=0;N<g;N++){const $=A-s+B,U=W-s+N;$>=0&&$<l&&U>=0&&U<c&&(I[b][y][A][W]+=t[b][L][$][U]*e[y][L][B][N])}return I}function S(t,e,n,s,o,r=1e-5){const[l,c,a,m]=[t.length,t[0].length,t[0][0].length,t[0][0][0].length],g=[];for(let h=0;h<l;h++){g[h]=[];for(let w=0;w<c;w++){g[h][w]=[];const I=e[w]/Math.sqrt(o[w]+r),b=n[w]-s[w]*I;for(let y=0;y<a;y++){g[h][w][y]=[];for(let L=0;L<m;L++)g[h][w][y][L]=t[h][w][y][L]*I+b}}}return g}function X(t){return t.map(e=>e.map(n=>n.map(s=>s.map(o=>Math.max(0,o)))))}function V(t,e,n){const s=e.length,o=[...n];for(let r=0;r<s;r++)for(let l=0;l<t.length;l++)o[r]+=t[l]*e[r][l];return o}function ot(t){const e=[];for(const n of t)for(const s of n)for(const o of s)for(const r of o)e.push(r);return e}function Pt(t){const e=Math.max(...t),n=t.map(o=>Math.exp(o-e)),s=n.reduce((o,r)=>o+r,0);return n.map(o=>o/s)}function Mt(t){return Math.tanh(t)}let d=null;async function kt(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load weights: ${e.status}`);d=await e.json(),console.log("AI model loaded successfully")}function St(t){const e=[[]];for(let o=0;o<3;o++){e[0][o]=[];for(let r=0;r<f;r++)e[0][o][r]=new Array(f).fill(0)}for(let o=0;o<t.length;o++){const r=Math.floor(o/f),l=o%f;t[o]===u.X?e[0][0][r][l]=1:t[o]===u.O&&(e[0][1][r][l]=1)}const s=O(t)===u.X?1:0;for(let o=0;o<f;o++)for(let r=0;r<f;r++)e[0][2][o][r]=s;return e}function Xt(t){if(!d)throw new Error("Model not loaded");let e=t;e=k(e,d["conv1.weight"],d["conv1.bias"]),e=S(e,d["bn1.weight"],d["bn1.bias"],d["bn1.running_mean"],d["bn1.running_var"]),e=X(e),e=k(e,d["conv2.weight"],d["conv2.bias"]),e=S(e,d["bn2.weight"],d["bn2.bias"],d["bn2.running_mean"],d["bn2.running_var"]),e=X(e),e=k(e,d["conv3.weight"],d["conv3.bias"]),e=S(e,d["bn3.weight"],d["bn3.bias"],d["bn3.running_mean"],d["bn3.running_var"]),e=X(e);let n=k(e,d["policy_conv.weight"],d["policy_conv.bias"],0);n=S(n,d["policy_bn.weight"],d["policy_bn.bias"],d["policy_bn.running_mean"],d["policy_bn.running_var"]),n=X(n);let s=ot(n);const o=V(s,d["policy_fc.weight"],d["policy_fc.bias"]);let r=k(e,d["value_conv.weight"],d["value_conv.bias"],0);r=S(r,d["value_bn.weight"],d["value_bn.bias"],d["value_bn.running_mean"],d["value_bn.running_var"]),r=X(r);let l=ot(r);l=V(l,d["value_fc1.weight"],d["value_fc1.bias"]),l=l.map(m=>Math.max(0,m));const c=V(l,d["value_fc2.weight"],d["value_fc2.bias"]),a=Mt(c[0]);return{policyLogits:o,value:a}}function _t(t,e,n,s=null){let o=[...t];s&&(o=t.map((h,w)=>h+s[w]));const r=o.map((h,w)=>e.includes(w)?h:-1/0);if(!e.some(h=>isFinite(r[h])))return console.warn("All moves are suicidal, picking random legal move"),e[Math.floor(Math.random()*e.length)];for(const h of e)if(r[h]===1/0)return h;const c=r.map(h=>isFinite(h)?h/n:h),a=Pt(c);if(a.some(isNaN))return console.error("NaN in probabilities, falling back to random"),e[Math.floor(Math.random()*e.length)];const m=Math.random();let g=0;for(let h=0;h<a.length;h++)if(g+=a[h],m<g)return h;return e[Math.floor(Math.random()*e.length)]}async function Tt(t,e){const n=R(t);if(n.length===0)throw new Error("No legal moves available");try{if(!d)return console.warn("Model not loaded, using random move"),{move:n[Math.floor(Math.random()*n.length)],guardrailWeight:0};const s=bt[e],o=O(t),r=t.filter(I=>I!==u.Empty).length,l=ht(r,e),c=Ct(t,o,r,e),a=St(t),{policyLogits:m}=Xt(a),g=_t(m,n,s,c);let h=0;const w=c[g];return w===1/0||w===-1/0?h=1:w>0&&(h=l),{move:g,guardrailWeight:h}}catch(s){return console.error("AI move calculation failed, using random move:",s),{move:n[Math.floor(Math.random()*n.length)],guardrailWeight:0}}}const st=400,rt=740,At=500,Wt=500,i={board:lt(),humanPlayer:u.X,twoPlayer:!1,difficulty:"medium",gameOver:!1,lastMove:null,result:null,checkmate:null};function v(){return i.twoPlayer}const mt="ziczaczoe_stats";function Bt(){try{const t=localStorage.getItem(mt);if(t)return JSON.parse(t)}catch{}return{won:0,lost:0}}function Nt(t){try{localStorage.setItem(mt,JSON.stringify(t))}catch{}}const _=Bt();let T={x:0,o:0};function Y(){const t=document.getElementById("stats-won"),e=document.getElementById("stats-lost");v()?(t.textContent=`X: ${String(T.x).padStart(3,"0")}`,e.textContent=`O: ${String(T.o).padStart(3,"0")}`,t.classList.add("x-score"),t.classList.remove("blinking"),e.classList.add("o-score"),e.classList.remove("blinking")):(t.textContent=`WON: ${String(_.won).padStart(3,"0")}`,e.textContent=`LOST: ${String(_.lost).padStart(3,"0")}`,t.classList.remove("x-score"),e.classList.remove("o-score"))}function Dt(){document.getElementById("stats-won")?.classList.remove("blinking"),document.getElementById("stats-lost")?.classList.remove("blinking")}function F(t,e){if(t===E.Draw)return;const s=(t===E.XWins?u.X:u.O)===e;s?_.won++:_.lost++,Nt(_),Y();const o=s?"stats-won":"stats-lost";document.getElementById(o)?.classList.add("blinking")}function it(t){if(t===E.Draw)return;const e=t===E.XWins?u.X:u.O;e===u.X?T.x++:T.o++,Y();const n=e===u.X?"stats-won":"stats-lost";document.getElementById(n)?.classList.add("blinking")}const H=document.getElementById("board"),p=document.getElementById("status"),j=document.getElementById("loading"),gt=document.getElementById("btn-mode"),q=document.getElementById("btn-player"),z=document.getElementById("btn-difficulty"),Ft=document.getElementById("btn-new-game"),G=["easy","medium","hard","expert"];function Ht(){H.innerHTML="";for(let t=0;t<f*f;t++){const e=document.createElement("div");e.className="cell",e.dataset.index=t.toString(),e.addEventListener("click",()=>Yt(t)),H.appendChild(e)}}function P(){const t=H.querySelectorAll(".cell"),e=O(i.board);H.classList.toggle("o-turn",v()&&e===u.O);let n=null,s=null,o=null;if(i.gameOver&&i.result){const{result:r}=i.result;if(r!==E.Draw){const l=r===E.XWins?u.X:u.O;v()?n=l===u.X?"end-x":"end-o":n=l===i.humanPlayer?"end-green":"end-red",s=new Set([...i.result.winningIndices,...i.result.losingIndices])}}if(i.checkmate?.isCheckmate){const r=i.checkmate.loser===u.X?u.O:u.X;v()?n=r===u.X?"end-x":"end-o":n=i.checkmate.loser!==i.humanPlayer?"end-green":"end-red",s=new Set([...i.checkmate.threatPatterns,...i.checkmate.suicidePatterns].flat()),o=new Set;for(const l of[...i.checkmate.threatPatterns,...i.checkmate.suicidePatterns])for(const c of l)i.board[c]===u.Empty&&o.add(c)}t.forEach((r,l)=>{const c=r,a=i.board[l];if(c.classList.remove("occupied","last-move-x","last-move-o","end-green","end-red","end-x","end-o","crux-blink","game-over"),a===u.Empty)c.innerHTML="";else{const m=a===u.X?"X":"O";let g;v()?g=a===u.X?"x":"o":g=a===i.humanPlayer?"x":"o",c.innerHTML=`<span class="piece ${g}">${m}</span>`,c.classList.add("occupied")}l===i.lastMove&&a!==u.Empty&&!i.gameOver&&c.classList.add(a===u.X?"last-move-x":"last-move-o"),i.gameOver&&(c.classList.add("game-over"),n&&s?.has(l)&&(c.classList.add(n),(o?.has(l)||l===i.lastMove)&&c.classList.add("crux-blink")))})}function M(){if(p.classList.remove("your-turn","x-turn","o-turn","win","lose","draw","x-wins","o-wins","hidden"),i.gameOver&&i.result){const{result:t}=i.result;if(t===E.Draw)p.textContent="TIE GAME",p.classList.add("draw");else{const e=t===E.XWins?u.X:u.O;if(v()){const n=e===u.X?"x-wins":"o-wins";i.checkmate?.isCheckmate?p.textContent="CHECKMATE!!":p.textContent=e===u.X?"X WINS!!":"O WINS!!",p.classList.add(n)}else{const n=e===i.humanPlayer;i.checkmate?.isCheckmate?(p.textContent="CHECKMATE!!",p.classList.add(n?"win":"lose")):n?(p.textContent="YOU WIN!!",p.classList.add("win")):(p.textContent="GAME OVER",p.classList.add("lose"))}}}else{const t=O(i.board);v()?(p.textContent=t===u.X?"X PLAYS":"O PLAYS",p.classList.add(t===u.X?"x-turn":"o-turn")):t===i.humanPlayer?(p.textContent="YOUR TURN",p.classList.add("your-turn")):p.classList.add("hidden")}}const Rt={easy:"EASY",medium:"MED",hard:"HARD",expert:"XPRT"};function D(){gt.textContent=i.twoPlayer?"2P":"1P",q.textContent=i.humanPlayer===u.X?"X":"O",q.classList.toggle("disabled",v()),z.textContent=Rt[i.difficulty],z.classList.toggle("disabled",v())}function C(){i.board=lt(),i.gameOver=!1,i.lastMove=null,i.result=null,i.checkmate=null,Dt(),P(),M(),!v()&&i.humanPlayer===u.O&&setTimeout(()=>wt(),Wt)}function Yt(t){if(i.gameOver)return;const e=O(i.board);!v()&&e!==i.humanPlayer||i.board[t]===u.Empty&&$t(t)}function $t(t){const e=O(i.board);i.board=ct(i.board,t),i.lastMove=t;const n=at(i.board,t);if(n.result!==E.Ongoing){i.gameOver=!0,i.result=n,v()?it(n.result):F(n.result,i.humanPlayer),P(),M();return}const s=e===u.X?u.O:u.X,o=dt(i.board,s);if(o.isCheckmate){i.gameOver=!0,i.checkmate=o;const r=e===u.X?E.XWins:E.OWins;i.result={result:r,winningIndices:[],losingIndices:[],losingPlayer:s},v()?it(r):F(r,i.humanPlayer),P(),M();return}P(),M(),v()||setTimeout(()=>wt(),At)}async function wt(){if(i.gameOver)return;const t=R(i.board);if(t.length===0)return;let e;try{ft()?e=Lt(i.board,O(i.board)):e=(await Tt(i.board,i.difficulty)).move}catch(o){console.error("AI move calculation failed, using random:",o),e=t[Math.floor(Math.random()*t.length)]}i.board=ct(i.board,e),i.lastMove=e;const n=at(i.board,e);if(n.result!==E.Ongoing){i.gameOver=!0,i.result=n,F(n.result,i.humanPlayer),P(),M();return}const s=dt(i.board,i.humanPlayer);if(s.isCheckmate){i.gameOver=!0,i.checkmate=s;const o=i.humanPlayer===u.X?E.OWins:E.XWins;i.result={result:o,winningIndices:[],losingIndices:[],losingPlayer:i.humanPlayer},F(o,i.humanPlayer)}P(),M()}function Ut(){gt.addEventListener("click",()=>{i.twoPlayer=!i.twoPlayer,i.twoPlayer&&(T={x:0,o:0}),D(),Y(),C()}),q.addEventListener("click",()=>{v()||(i.humanPlayer=i.humanPlayer===u.X?u.O:u.X,D(),C())}),z.addEventListener("click",()=>{if(v())return;const e=(G.indexOf(i.difficulty)+1)%G.length;i.difficulty=G[e],D(),C()}),Ft.addEventListener("click",()=>{C()})}function K(){const t=window.innerWidth,e=window.innerHeight,n=Math.min(t/st,e/rt),s=document.getElementById("app");s.style.transform=`scale(${n})`,s.style.transformOrigin="top center",s.style.width=`${st}px`,s.style.height=`${rt}px`}async function Vt(){if(K(),window.addEventListener("resize",K),window.addEventListener("orientationchange",()=>{setTimeout(K,100)}),Ht(),Ut(),D(),Y(),ft())j.classList.add("hidden"),C();else try{await kt("./weights.json"),j.classList.add("hidden"),C()}catch(t){console.error("Failed to load model:",t);const e=j.querySelector(".loading-text");e.textContent="FAILED TO LOAD AI",t instanceof Error&&console.error("Error details:",t.message)}}Vt();
