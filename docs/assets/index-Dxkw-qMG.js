(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const u=6,vt=4,pt=3;var f=(t=>(t[t.Empty=0]="Empty",t[t.X=1]="X",t[t.O=2]="O",t))(f||{}),L=(t=>(t[t.Ongoing=0]="Ongoing",t[t.XWins=1]="XWins",t[t.OWins=2]="OWins",t[t.Draw=3]="Draw",t))(L||{});function rt(){return new Array(u*u).fill(0)}function C(t){return t.filter(n=>n!==0).length%2===0?1:2}function Y(t){const e=[];for(let n=0;n<t.length;n++)t[n]===0&&e.push(n);return e}function lt(t,e){if(t[e]!==0)throw new Error(`Cell ${e} is not empty`);const n=[...t];return n[e]=C(t),n}function yt(t){return[Math.floor(t/u),t%u]}function It(t,e){return t*u+e}function tt(t,e,n,s,o,i){const l=[];let a=e,c=n;for(;a>=0&&a<u&&c>=0&&c<u;){const m=It(a,c);if(t[m]===i)l.push(m),a+=s,c+=o;else break}return l}function ct(t,e){const n=t.filter(m=>m!==0).length,s=n%2===1?1:2,[o,i]=yt(e),l=[[0,1],[1,0],[1,1],[1,-1]];let a=0,c=[];for(const[m,g]of l){const d=tt(t,o+m,i+g,m,g,s),y=[...tt(t,o-m,i-g,-m,-g,s).reverse(),e,...d];y.length>a&&(a=y.length,c=y)}return a>=vt?{result:s===1?1:2,winningIndices:c,losingIndices:[],losingPlayer:null}:a===pt?{result:(s===1?2:1)===1?1:2,winningIndices:[],losingIndices:c,losingPlayer:s}:n===u*u?{result:3,winningIndices:[],losingIndices:[],losingPlayer:null}:{result:0,winningIndices:[],losingIndices:[],losingPlayer:null}}const at=f.Empty,O=[];function Et(){for(let t=0;t<u;t++){const e=[];for(let n=0;n<u;n++)e.push(t*u+n);O.push(e)}for(let t=0;t<u;t++){const e=[];for(let n=0;n<u;n++)e.push(n*u+t);O.push(e)}for(let t=0;t<u;t++){const e=[];let n=0,s=t;for(;n<u&&s<u;)e.push(n*u+s),n++,s++;e.length>=3&&O.push(e)}for(let t=1;t<u;t++){const e=[];let n=t,s=0;for(;n<u&&s<u;)e.push(n*u+s),n++,s++;e.length>=3&&O.push(e)}for(let t=0;t<u;t++){const e=[];let n=u-1,s=t;for(;n>=0&&s<u;)e.push(n*u+s),n--,s++;e.length>=3&&O.push(e)}for(let t=u-2;t>=0;t--){const e=[];let n=t,s=0;for(;n>=0&&s<u;)e.push(n*u+s),n--,s++;e.length>=3&&O.push(e)}}Et();function J(t,e,n){const s=[...t];s[e]=n;for(const o of O)if(o.includes(e))for(let i=0;i<=o.length-3;i++){const l=[o[i],o[i+1],o[i+2]];let a=0;for(const c of l)s[c]===n&&a++;if(a===3)return!0}return!1}function Z(t,e,n){const s=[...t];s[e]=n;for(const o of O)if(o.includes(e))for(let i=0;i<=o.length-4;i++){const l=[o[i],o[i+1],o[i+2],o[i+3]];let a=0;for(const c of l)s[c]===n&&a++;if(a===4)return!0}return!1}function Q(t,e){const n=new Set;for(const s of O)for(let o=0;o<=s.length-4;o++){const i=[s[o],s[o+1],s[o+2],s[o+3]];let l=0,a=-1,c=0;for(const m of i)t[m]===e?l++:t[m]===at&&(c++,a=m);l===3&&c===1&&n.add(a)}return Array.from(n)}function bt(t,e){const n=e===f.X?f.O:f.X,s=Y(t);if(s.length===0)throw new Error("No legal moves available");for(const l of s)if(Z(t,l,e))return l;const o=Q(t,n),i=s.filter(l=>!J(t,l,e));if(o.length>0){const l=o.filter(a=>i.includes(a));if(l.length>0)return l[0]}return i.length>0?i[Math.floor(Math.random()*i.length)]:s[Math.floor(Math.random()*s.length)]}function ut(){return new URLSearchParams(window.location.search).get("rules")==="1"}function et(t,e,n){const s=[],o=[...t];o[e]=n;for(const i of O)if(i.includes(e))for(let l=0;l<=i.length-3;l++){const a=[i[l],i[l+1],i[l+2]];let c=0;for(const m of a)o[m]===n&&c++;c===3&&s.push(a)}return s}function nt(t,e,n){for(const s of O)if(s.includes(e))for(let o=0;o<=s.length-4;o++){const i=[s[o],s[o+1],s[o+2],s[o+3]];if(!i.includes(e))continue;let l=0,a=0;for(const c of i)t[c]===n?l++:t[c]===at&&a++;if(l===3&&a===1)return i}return null}function ft(t,e){const n=e===f.X?f.O:f.X,s=Y(t),o={isCheckmate:!1,loser:null,threatPatterns:[],suicidePatterns:[]};if(s.length===0)return o;for(const a of s)if(Z(t,a,e))return o;const i=Q(t,n),l=s.filter(a=>J(t,a,e));if(i.length>0){if(i.length>=2){const c=[];for(const m of i){const g=nt(t,m,n);g&&c.push(g)}return{isCheckmate:!0,loser:e,threatPatterns:c,suicidePatterns:[]}}const a=i.filter(c=>l.includes(c));if(a.length>0){const c=[],m=[];for(const g of a){const d=nt(t,g,n);d&&c.push(d);const w=et(t,g,e);m.push(...w)}return{isCheckmate:!0,loser:e,threatPatterns:c,suicidePatterns:m}}}if(l.length===s.length){const a=[];for(const c of l){const m=et(t,c,e);a.push(...m)}return{isCheckmate:!0,loser:e,threatPatterns:[],suicidePatterns:a}}return o}const Ot={easy:3,medium:1.5,hard:1,expert:.1},Lt={easy:2,medium:1,hard:.5,expert:0},Ct=20;function ht(t,e){const n=Lt[e],s=t/36;return Math.max(0,1-s*n)}function Mt(t,e,n,s){const o=e===f.X?f.O:f.X,i=new Array(u*u).fill(0),l=ht(n,s),a=new Set(Q(t,o));for(let c=0;c<i.length;c++)if(t[c]===f.Empty){if(Z(t,c,e)){i[c]=1/0;continue}if(J(t,c,e)){i[c]=-1/0;continue}a.has(c)&&(i[c]=Ct*l)}return i}function k(t,e,n,s=1){const[o,i,l,a]=[t.length,t[0].length,t[0][0].length,t[0][0][0].length],[c,,m,g]=[e.length,e[0].length,e[0][0].length,e[0][0][0].length],d=l+2*s-m+1,w=a+2*s-g+1,y=[];for(let b=0;b<o;b++){y[b]=[];for(let p=0;p<c;p++){y[b][p]=[];for(let I=0;I<d;I++)y[b][p][I]=new Array(w).fill(n[p])}}for(let b=0;b<o;b++)for(let p=0;p<c;p++)for(let I=0;I<i;I++)for(let A=0;A<d;A++)for(let X=0;X<w;X++)for(let N=0;N<m;N++)for(let W=0;W<g;W++){const U=A-s+N,$=X-s+W;U>=0&&U<l&&$>=0&&$<a&&(y[b][p][A][X]+=t[b][I][U][$]*e[p][I][N][W])}return y}function S(t,e,n,s,o,i=1e-5){const[l,a,c,m]=[t.length,t[0].length,t[0][0].length,t[0][0][0].length],g=[];for(let d=0;d<l;d++){g[d]=[];for(let w=0;w<a;w++){g[d][w]=[];const y=e[w]/Math.sqrt(o[w]+i),b=n[w]-s[w]*y;for(let p=0;p<c;p++){g[d][w][p]=[];for(let I=0;I<m;I++)g[d][w][p][I]=t[d][w][p][I]*y+b}}}return g}function _(t){return t.map(e=>e.map(n=>n.map(s=>s.map(o=>Math.max(0,o)))))}function j(t,e,n){const s=e.length,o=[...n];for(let i=0;i<s;i++)for(let l=0;l<t.length;l++)o[i]+=t[l]*e[i][l];return o}function ot(t){const e=[];for(const n of t)for(const s of n)for(const o of s)for(const i of o)e.push(i);return e}function Pt(t){const e=Math.max(...t),n=t.map(o=>Math.exp(o-e)),s=n.reduce((o,i)=>o+i,0);return n.map(o=>o/s)}function xt(t){return Math.tanh(t)}let h=null;async function kt(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load weights: ${e.status}`);h=await e.json(),console.log("AI model loaded successfully")}function St(t){const e=[[]];for(let o=0;o<3;o++){e[0][o]=[];for(let i=0;i<u;i++)e[0][o][i]=new Array(u).fill(0)}for(let o=0;o<t.length;o++){const i=Math.floor(o/u),l=o%u;t[o]===f.X?e[0][0][i][l]=1:t[o]===f.O&&(e[0][1][i][l]=1)}const s=C(t)===f.X?1:0;for(let o=0;o<u;o++)for(let i=0;i<u;i++)e[0][2][o][i]=s;return e}function _t(t){if(!h)throw new Error("Model not loaded");let e=t;e=k(e,h["conv1.weight"],h["conv1.bias"]),e=S(e,h["bn1.weight"],h["bn1.bias"],h["bn1.running_mean"],h["bn1.running_var"]),e=_(e),e=k(e,h["conv2.weight"],h["conv2.bias"]),e=S(e,h["bn2.weight"],h["bn2.bias"],h["bn2.running_mean"],h["bn2.running_var"]),e=_(e),e=k(e,h["conv3.weight"],h["conv3.bias"]),e=S(e,h["bn3.weight"],h["bn3.bias"],h["bn3.running_mean"],h["bn3.running_var"]),e=_(e);let n=k(e,h["policy_conv.weight"],h["policy_conv.bias"],0);n=S(n,h["policy_bn.weight"],h["policy_bn.bias"],h["policy_bn.running_mean"],h["policy_bn.running_var"]),n=_(n);let s=ot(n);const o=j(s,h["policy_fc.weight"],h["policy_fc.bias"]);let i=k(e,h["value_conv.weight"],h["value_conv.bias"],0);i=S(i,h["value_bn.weight"],h["value_bn.bias"],h["value_bn.running_mean"],h["value_bn.running_var"]),i=_(i);let l=ot(i);l=j(l,h["value_fc1.weight"],h["value_fc1.bias"]),l=l.map(m=>Math.max(0,m));const a=j(l,h["value_fc2.weight"],h["value_fc2.bias"]),c=xt(a[0]);return{policyLogits:o,value:c}}function Tt(t,e,n,s=null){let o=[...t];s&&(o=t.map((d,w)=>d+s[w]));const i=o.map((d,w)=>e.includes(w)?d:-1/0);if(!e.some(d=>isFinite(i[d])))return console.warn("All moves are suicidal, picking random legal move"),e[Math.floor(Math.random()*e.length)];for(const d of e)if(i[d]===1/0)return d;const a=i.map(d=>isFinite(d)?d/n:d),c=Pt(a);if(c.some(isNaN))return console.error("NaN in probabilities, falling back to random"),e[Math.floor(Math.random()*e.length)];const m=Math.random();let g=0;for(let d=0;d<c.length;d++)if(g+=c[d],m<g)return d;return e[Math.floor(Math.random()*e.length)]}async function At(t,e){const n=Y(t);if(n.length===0)throw new Error("No legal moves available");try{if(!h)return console.warn("Model not loaded, using random move"),{move:n[Math.floor(Math.random()*n.length)],guardrailWeight:0};const s=Ot[e],o=C(t),i=t.filter(y=>y!==f.Empty).length,l=ht(i,e),a=Mt(t,o,i,e),c=St(t),{policyLogits:m}=_t(c),g=Tt(m,n,s,a);let d=0;const w=a[g];return w===1/0||w===-1/0?d=1:w>0&&(d=l),{move:g,guardrailWeight:d}}catch(s){return console.error("AI move calculation failed, using random move:",s),{move:n[Math.floor(Math.random()*n.length)],guardrailWeight:0}}}const st=400,it=740,Xt=500,Nt=500,r={board:rt(),humanPlayer:f.X,twoPlayer:!1,difficulty:"medium",gameOver:!1,lastMove:null,result:null,checkmate:null};function E(){return r.twoPlayer}const dt="ziczaczoe_stats";function Wt(){try{const t=localStorage.getItem(dt);if(t)return JSON.parse(t)}catch{}return{won:0,lost:0}}function Bt(t){try{localStorage.setItem(dt,JSON.stringify(t))}catch{}}const T=Wt();function mt(){const t=document.getElementById("stats-won"),e=document.getElementById("stats-lost");t.textContent=`WON: ${String(T.won).padStart(3,"0")}`,e.textContent=`LOST: ${String(T.lost).padStart(3,"0")}`}function Dt(){document.getElementById("stats-won")?.classList.remove("pulsing"),document.getElementById("stats-lost")?.classList.remove("pulsing")}function R(t,e){if(t===L.Draw)return;const s=(t===L.XWins?f.X:f.O)===e;s?T.won++:T.lost++,Bt(T),mt();const o=s?"stats-won":"stats-lost";document.getElementById(o)?.classList.add("pulsing")}const V=document.getElementById("board"),v=document.getElementById("status"),q=document.getElementById("loading"),Ft=document.querySelector(".stats"),gt=document.getElementById("btn-mode"),z=document.getElementById("btn-player"),G=document.getElementById("btn-difficulty"),Ht=document.getElementById("btn-new-game"),B=[{value:!1,label:"1-PLAYER"},{value:!0,label:"2-PLAYER"}],D=[{value:f.X,label:"X (1ST)"},{value:f.O,label:"O (2ND)"}],F=[{value:"easy",label:"EASY"},{value:"medium",label:"MEDIUM"},{value:"hard",label:"HARD"},{value:"expert",label:"EXPERT"}];function Rt(){V.innerHTML="";for(let t=0;t<u*u;t++){const e=document.createElement("div");e.className="cell",e.dataset.index=t.toString(),e.addEventListener("click",()=>Yt(t)),V.appendChild(e)}}function P(){const t=V.querySelectorAll(".cell");let e=null,n=null;r.checkmate?.isCheckmate&&(E()?e=(r.checkmate.loser===f.X?f.O:f.X)===f.X?"checkmate-win-highlight":"checkmate-lose-highlight":e=r.checkmate.loser!==r.humanPlayer?"checkmate-win-highlight":"checkmate-lose-highlight",n=new Set([...r.checkmate.threatPatterns,...r.checkmate.suicidePatterns].flat())),t.forEach((s,o)=>{const i=s,l=r.board[o];if(i.classList.remove("occupied","last-move","win-highlight","lose-highlight","checkmate-win-highlight","checkmate-lose-highlight","game-over"),l===f.Empty)i.innerHTML="";else{const a=l===f.X?"X":"O",c=l===f.X?"x":"o";i.innerHTML=`<span class="piece ${c}">${a}</span>`,i.classList.add("occupied")}o===r.lastMove&&i.classList.add("last-move"),r.gameOver&&i.classList.add("game-over"),r.result&&(r.result.winningIndices.includes(o)&&i.classList.add("win-highlight"),r.result.losingIndices.includes(o)&&i.classList.add("lose-highlight")),e&&n?.has(o)&&i.classList.add(e)})}function x(){if(v.classList.remove("your-turn","win","lose","draw","x-wins","o-wins"),r.gameOver&&r.result){const{result:t}=r.result;if(t===L.Draw)v.textContent="TIE!",v.classList.add("draw");else{const e=t===L.XWins?f.X:f.O;if(E()){const n=e===f.X?"x-wins":"o-wins";r.checkmate?.isCheckmate?v.textContent="CHECKMATE!!":v.textContent=e===f.X?"X WINS!":"O WINS!",v.classList.add(n)}else{const n=e===r.humanPlayer;r.checkmate?.isCheckmate?(v.textContent="CHECKMATE!!",v.classList.add(n?"win":"lose")):n?(v.textContent="YOU WIN!!!",v.classList.add("win")):(v.textContent="GAME OVER",v.classList.add("lose"))}}}else{const t=C(r.board);E()?(v.textContent=t===f.X?"X PLAYS":"O PLAYS",v.classList.add("your-turn")):t===r.humanPlayer?(v.textContent="YOUR TURN",v.classList.add("your-turn")):v.textContent=""}}function H(){const t=B.find(s=>s.value===r.twoPlayer);gt.textContent=t?.label??"1-PLAYER";const e=D.find(s=>s.value===r.humanPlayer);z.textContent=e?.label??"X (1ST)",z.classList.toggle("disabled",E());const n=F.find(s=>s.value===r.difficulty);G.textContent=n?.label??"MEDIUM",G.classList.toggle("disabled",E()),Ft.style.visibility=E()?"hidden":"visible"}function M(){r.board=rt(),r.gameOver=!1,r.lastMove=null,r.result=null,r.checkmate=null,Dt(),P(),x(),!E()&&r.humanPlayer===f.O&&setTimeout(()=>wt(),Nt)}function Yt(t){if(r.gameOver)return;const e=C(r.board);!E()&&e!==r.humanPlayer||r.board[t]===f.Empty&&Ut(t)}function Ut(t){const e=C(r.board);r.board=lt(r.board,t),r.lastMove=t;const n=ct(r.board,t);if(n.result!==L.Ongoing){r.gameOver=!0,r.result=n,E()||R(n.result,r.humanPlayer),P(),x();return}const s=e===f.X?f.O:f.X,o=ft(r.board,s);if(o.isCheckmate){r.gameOver=!0,r.checkmate=o;const i=e===f.X?L.XWins:L.OWins;r.result={result:i,winningIndices:[],losingIndices:[],losingPlayer:s},E()||R(i,r.humanPlayer),P(),x();return}P(),x(),E()||setTimeout(()=>wt(),Xt)}async function wt(){if(r.gameOver)return;const t=Y(r.board);if(t.length===0)return;let e;try{ut()?e=bt(r.board,C(r.board)):e=(await At(r.board,r.difficulty)).move}catch(o){console.error("AI move calculation failed, using random:",o),e=t[Math.floor(Math.random()*t.length)]}r.board=lt(r.board,e),r.lastMove=e;const n=ct(r.board,e);if(n.result!==L.Ongoing){r.gameOver=!0,r.result=n,R(n.result,r.humanPlayer),P(),x();return}const s=ft(r.board,r.humanPlayer);if(s.isCheckmate){r.gameOver=!0,r.checkmate=s;const o=r.humanPlayer===f.X?L.OWins:L.XWins;r.result={result:o,winningIndices:[],losingIndices:[],losingPlayer:r.humanPlayer},R(o,r.humanPlayer)}P(),x()}function $t(){gt.addEventListener("click",()=>{const e=(B.findIndex(n=>n.value===r.twoPlayer)+1)%B.length;r.twoPlayer=B[e].value,H(),M()}),z.addEventListener("click",()=>{if(E())return;const e=(D.findIndex(n=>n.value===r.humanPlayer)+1)%D.length;r.humanPlayer=D[e].value,H(),M()}),G.addEventListener("click",()=>{if(E())return;const e=(F.findIndex(n=>n.value===r.difficulty)+1)%F.length;r.difficulty=F[e].value,H(),M()}),Ht.addEventListener("click",()=>{M()})}function K(){const t=window.innerWidth,e=window.innerHeight,n=Math.min(t/st,e/it),s=document.getElementById("app");s.style.transform=`scale(${n})`,s.style.transformOrigin="top center",s.style.width=`${st}px`,s.style.height=`${it}px`}async function jt(){if(K(),window.addEventListener("resize",K),window.addEventListener("orientationchange",()=>{setTimeout(K,100)}),Rt(),$t(),H(),mt(),ut())q.classList.add("hidden"),M();else try{await kt("./weights.json"),q.classList.add("hidden"),M()}catch(t){console.error("Failed to load model:",t);const e=q.querySelector(".loading-text");e.textContent="FAILED TO LOAD AI",t instanceof Error&&console.error("Error details:",t.message)}}jt();
