(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const f=6,pt=4,yt=3;var u=(t=>(t[t.Empty=0]="Empty",t[t.X=1]="X",t[t.O=2]="O",t))(u||{}),E=(t=>(t[t.Ongoing=0]="Ongoing",t[t.XWins=1]="XWins",t[t.OWins=2]="OWins",t[t.Draw=3]="Draw",t))(E||{});function lt(){return new Array(f*f).fill(0)}function C(t){return t.filter(o=>o!==0).length%2===0?1:2}function R(t){const e=[];for(let o=0;o<t.length;o++)t[o]===0&&e.push(o);return e}function ct(t,e){if(t[e]!==0)throw new Error(`Cell ${e} is not empty`);const o=[...t];return o[e]=C(t),o}function vt(t){return[Math.floor(t/f),t%f]}function It(t,e){return t*f+e}function tt(t,e,o,i,n,s){const l=[];let a=e,c=o;for(;a>=0&&a<f&&c>=0&&c<f;){const g=It(a,c);if(t[g]===s)l.push(g),a+=i,c+=n;else break}return l}function at(t,e){const o=t.filter(g=>g!==0).length,i=o%2===1?1:2,[n,s]=vt(e),l=[[0,1],[1,0],[1,1],[1,-1]];let a=0,c=[];for(const[g,m]of l){const d=tt(t,n+g,s+m,g,m,i),v=[...tt(t,n-g,s-m,-g,-m,i).reverse(),e,...d];v.length>a&&(a=v.length,c=v)}return a>=pt?{result:i===1?1:2,winningIndices:c,losingIndices:[],losingPlayer:null}:a===yt?{result:(i===1?2:1)===1?1:2,winningIndices:[],losingIndices:c,losingPlayer:i}:o===f*f?{result:3,winningIndices:[],losingIndices:[],losingPlayer:null}:{result:0,winningIndices:[],losingIndices:[],losingPlayer:null}}const ut=u.Empty,O=[];function Lt(){for(let t=0;t<f;t++){const e=[];for(let o=0;o<f;o++)e.push(t*f+o);O.push(e)}for(let t=0;t<f;t++){const e=[];for(let o=0;o<f;o++)e.push(o*f+t);O.push(e)}for(let t=0;t<f;t++){const e=[];let o=0,i=t;for(;o<f&&i<f;)e.push(o*f+i),o++,i++;e.length>=3&&O.push(e)}for(let t=1;t<f;t++){const e=[];let o=t,i=0;for(;o<f&&i<f;)e.push(o*f+i),o++,i++;e.length>=3&&O.push(e)}for(let t=0;t<f;t++){const e=[];let o=f-1,i=t;for(;o>=0&&i<f;)e.push(o*f+i),o--,i++;e.length>=3&&O.push(e)}for(let t=f-2;t>=0;t--){const e=[];let o=t,i=0;for(;o>=0&&i<f;)e.push(o*f+i),o--,i++;e.length>=3&&O.push(e)}}Lt();function J(t,e,o){const i=[...t];i[e]=o;for(const n of O)if(n.includes(e))for(let s=0;s<=n.length-3;s++){const l=[n[s],n[s+1],n[s+2]];let a=0;for(const c of l)i[c]===o&&a++;if(a===3)return!0}return!1}function Z(t,e,o){const i=[...t];i[e]=o;for(const n of O)if(n.includes(e))for(let s=0;s<=n.length-4;s++){const l=[n[s],n[s+1],n[s+2],n[s+3]];let a=0;for(const c of l)i[c]===o&&a++;if(a===4)return!0}return!1}function Q(t,e){const o=new Set;for(const i of O)for(let n=0;n<=i.length-4;n++){const s=[i[n],i[n+1],i[n+2],i[n+3]];let l=0,a=-1,c=0;for(const g of s)t[g]===e?l++:t[g]===ut&&(c++,a=g);l===3&&c===1&&o.add(a)}return Array.from(o)}function Et(t,e){const o=e===u.X?u.O:u.X,i=R(t);if(i.length===0)throw new Error("No legal moves available");for(const l of i)if(Z(t,l,e))return l;const n=Q(t,o),s=i.filter(l=>!J(t,l,e));if(n.length>0){const l=n.filter(a=>s.includes(a));if(l.length>0)return l[0]}return s.length>0?s[Math.floor(Math.random()*s.length)]:i[Math.floor(Math.random()*i.length)]}function ft(){return new URLSearchParams(window.location.search).get("rules")==="1"}function et(t,e,o){const i=[],n=[...t];n[e]=o;for(const s of O)if(s.includes(e))for(let l=0;l<=s.length-3;l++){const a=[s[l],s[l+1],s[l+2]];let c=0;for(const g of a)n[g]===o&&c++;c===3&&i.push(a)}return i}function nt(t,e,o){for(const i of O)if(i.includes(e))for(let n=0;n<=i.length-4;n++){const s=[i[n],i[n+1],i[n+2],i[n+3]];if(!s.includes(e))continue;let l=0,a=0;for(const c of s)t[c]===o?l++:t[c]===ut&&a++;if(l===3&&a===1)return s}return null}function ht(t,e){const o=e===u.X?u.O:u.X,i=R(t),n={isCheckmate:!1,loser:null,threatPatterns:[],suicidePatterns:[]};if(i.length===0)return n;for(const a of i)if(Z(t,a,e))return n;const s=Q(t,o),l=i.filter(a=>J(t,a,e));if(s.length>0){if(s.length>=2){const c=[];for(const g of s){const m=nt(t,g,o);m&&c.push(m)}return{isCheckmate:!0,loser:e,threatPatterns:c,suicidePatterns:[]}}const a=s.filter(c=>l.includes(c));if(a.length>0){const c=[],g=[];for(const m of a){const d=nt(t,m,o);d&&c.push(d);const w=et(t,m,e);g.push(...w)}return{isCheckmate:!0,loser:e,threatPatterns:c,suicidePatterns:g}}}if(l.length===i.length){const a=[];for(const c of l){const g=et(t,c,e);a.push(...g)}return{isCheckmate:!0,loser:e,threatPatterns:[],suicidePatterns:a}}return n}const bt={easy:3,medium:1.5,hard:1,expert:.1},Ot={easy:2,medium:1,hard:.5,expert:0},Ct=20;function dt(t,e){const o=Ot[e],i=t/36;return Math.max(0,1-i*o)}function kt(t,e,o,i){const n=e===u.X?u.O:u.X,s=new Array(f*f).fill(0),l=dt(o,i),a=new Set(Q(t,n));for(let c=0;c<s.length;c++)if(t[c]===u.Empty){if(Z(t,c,e)){s[c]=1/0;continue}if(J(t,c,e)){s[c]=-1/0;continue}a.has(c)&&(s[c]=Ct*l)}return s}function P(t,e,o,i=1){const[n,s,l,a]=[t.length,t[0].length,t[0][0].length,t[0][0][0].length],[c,,g,m]=[e.length,e[0].length,e[0][0].length,e[0][0][0].length],d=l+2*i-g+1,w=a+2*i-m+1,v=[];for(let b=0;b<n;b++){v[b]=[];for(let y=0;y<c;y++){v[b][y]=[];for(let L=0;L<d;L++)v[b][y][L]=new Array(w).fill(o[y])}}for(let b=0;b<n;b++)for(let y=0;y<c;y++)for(let L=0;L<s;L++)for(let T=0;T<d;T++)for(let W=0;W<w;W++)for(let B=0;B<g;B++)for(let N=0;N<m;N++){const $=T-i+B,U=W-i+N;$>=0&&$<l&&U>=0&&U<a&&(v[b][y][T][W]+=t[b][L][$][U]*e[y][L][B][N])}return v}function S(t,e,o,i,n,s=1e-5){const[l,a,c,g]=[t.length,t[0].length,t[0][0].length,t[0][0][0].length],m=[];for(let d=0;d<l;d++){m[d]=[];for(let w=0;w<a;w++){m[d][w]=[];const v=e[w]/Math.sqrt(n[w]+s),b=o[w]-i[w]*v;for(let y=0;y<c;y++){m[d][w][y]=[];for(let L=0;L<g;L++)m[d][w][y][L]=t[d][w][y][L]*v+b}}}return m}function X(t){return t.map(e=>e.map(o=>o.map(i=>i.map(n=>Math.max(0,n)))))}function q(t,e,o){const i=e.length,n=[...o];for(let s=0;s<i;s++)for(let l=0;l<t.length;l++)n[s]+=t[l]*e[s][l];return n}function ot(t){const e=[];for(const o of t)for(const i of o)for(const n of i)for(const s of n)e.push(s);return e}function xt(t){const e=Math.max(...t),o=t.map(n=>Math.exp(n-e)),i=o.reduce((n,s)=>n+s,0);return o.map(n=>n/i)}function Mt(t){return Math.tanh(t)}let h=null;async function Pt(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load weights: ${e.status}`);h=await e.json(),console.log("AI model loaded successfully")}function St(t){const e=[[]];for(let n=0;n<3;n++){e[0][n]=[];for(let s=0;s<f;s++)e[0][n][s]=new Array(f).fill(0)}for(let n=0;n<t.length;n++){const s=Math.floor(n/f),l=n%f;t[n]===u.X?e[0][0][s][l]=1:t[n]===u.O&&(e[0][1][s][l]=1)}const i=C(t)===u.X?1:0;for(let n=0;n<f;n++)for(let s=0;s<f;s++)e[0][2][n][s]=i;return e}function Xt(t){if(!h)throw new Error("Model not loaded");let e=t;e=P(e,h["conv1.weight"],h["conv1.bias"]),e=S(e,h["bn1.weight"],h["bn1.bias"],h["bn1.running_mean"],h["bn1.running_var"]),e=X(e),e=P(e,h["conv2.weight"],h["conv2.bias"]),e=S(e,h["bn2.weight"],h["bn2.bias"],h["bn2.running_mean"],h["bn2.running_var"]),e=X(e),e=P(e,h["conv3.weight"],h["conv3.bias"]),e=S(e,h["bn3.weight"],h["bn3.bias"],h["bn3.running_mean"],h["bn3.running_var"]),e=X(e);let o=P(e,h["policy_conv.weight"],h["policy_conv.bias"],0);o=S(o,h["policy_bn.weight"],h["policy_bn.bias"],h["policy_bn.running_mean"],h["policy_bn.running_var"]),o=X(o);let i=ot(o);const n=q(i,h["policy_fc.weight"],h["policy_fc.bias"]);let s=P(e,h["value_conv.weight"],h["value_conv.bias"],0);s=S(s,h["value_bn.weight"],h["value_bn.bias"],h["value_bn.running_mean"],h["value_bn.running_var"]),s=X(s);let l=ot(s);l=q(l,h["value_fc1.weight"],h["value_fc1.bias"]),l=l.map(g=>Math.max(0,g));const a=q(l,h["value_fc2.weight"],h["value_fc2.bias"]),c=Mt(a[0]);return{policyLogits:n,value:c}}function _t(t,e,o,i=null){let n=[...t];i&&(n=t.map((d,w)=>d+i[w]));const s=n.map((d,w)=>e.includes(w)?d:-1/0);if(!e.some(d=>isFinite(s[d])))return console.warn("All moves are suicidal, picking random legal move"),e[Math.floor(Math.random()*e.length)];for(const d of e)if(s[d]===1/0)return d;const a=s.map(d=>isFinite(d)?d/o:d),c=xt(a);if(c.some(isNaN))return console.error("NaN in probabilities, falling back to random"),e[Math.floor(Math.random()*e.length)];const g=Math.random();let m=0;for(let d=0;d<c.length;d++)if(m+=c[d],g<m)return d;return e[Math.floor(Math.random()*e.length)]}async function At(t,e){const o=R(t);if(o.length===0)throw new Error("No legal moves available");try{if(!h)return console.warn("Model not loaded, using random move"),{move:o[Math.floor(Math.random()*o.length)],guardrailWeight:0};const i=bt[e],n=C(t),s=t.filter(v=>v!==u.Empty).length,l=dt(s,e),a=kt(t,n,s,e),c=St(t),{policyLogits:g}=Xt(c),m=_t(g,o,i,a);let d=0;const w=a[m];return w===1/0||w===-1/0?d=1:w>0&&(d=l),{move:m,guardrailWeight:d}}catch(i){return console.error("AI move calculation failed, using random move:",i),{move:o[Math.floor(Math.random()*o.length)],guardrailWeight:0}}}const st=400,it=740,Tt=500,Wt=500,r={board:lt(),humanPlayer:u.X,twoPlayer:!1,difficulty:"medium",gameOver:!1,lastMove:null,result:null,checkmate:null};function I(){return r.twoPlayer}const gt="ziczaczoe_stats";function Bt(){try{const t=localStorage.getItem(gt);if(t)return JSON.parse(t)}catch{}return{won:0,lost:0}}function Nt(t){try{localStorage.setItem(gt,JSON.stringify(t))}catch{}}const _=Bt();let A={x:0,o:0};function Y(){const t=document.getElementById("stats-won"),e=document.getElementById("stats-lost");I()?(t.textContent=`X: ${String(A.x).padStart(3,"0")}`,e.textContent=`O: ${String(A.o).padStart(3,"0")}`,t.classList.add("x-score"),t.classList.remove("blinking"),e.classList.add("o-score"),e.classList.remove("blinking")):(t.textContent=`WON: ${String(_.won).padStart(3,"0")}`,e.textContent=`LOST: ${String(_.lost).padStart(3,"0")}`,t.classList.remove("x-score"),e.classList.remove("o-score"))}function Dt(){document.getElementById("stats-won")?.classList.remove("blinking"),document.getElementById("stats-lost")?.classList.remove("blinking")}function H(t,e){if(t===E.Draw)return;const i=(t===E.XWins?u.X:u.O)===e;i?_.won++:_.lost++,Nt(_),Y();const n=i?"stats-won":"stats-lost";document.getElementById(n)?.classList.add("blinking")}function rt(t){if(t===E.Draw)return;const e=t===E.XWins?u.X:u.O;e===u.X?A.x++:A.o++,Y();const o=e===u.X?"stats-won":"stats-lost";document.getElementById(o)?.classList.add("blinking")}const G=document.getElementById("board"),p=document.getElementById("status"),V=document.getElementById("loading"),mt=document.getElementById("btn-mode"),K=document.getElementById("btn-player"),z=document.getElementById("btn-difficulty"),Ft=document.getElementById("btn-new-game"),D=["easy","medium","hard","expert"];function Ht(){G.innerHTML="";for(let t=0;t<f*f;t++){const e=document.createElement("div");e.className="cell",e.dataset.index=t.toString(),e.addEventListener("click",()=>Rt(t)),G.appendChild(e)}}function x(){const t=G.querySelectorAll(".cell");let e=null,o=null;r.checkmate?.isCheckmate&&(I()?e=(r.checkmate.loser===u.X?u.O:u.X)===u.X?"checkmate-win-highlight":"checkmate-lose-highlight":e=r.checkmate.loser!==r.humanPlayer?"checkmate-win-highlight":"checkmate-lose-highlight",o=new Set([...r.checkmate.threatPatterns,...r.checkmate.suicidePatterns].flat())),t.forEach((i,n)=>{const s=i,l=r.board[n];if(s.classList.remove("occupied","last-move","win-highlight","lose-highlight","checkmate-win-highlight","checkmate-lose-highlight","game-over"),l===u.Empty)s.innerHTML="";else{const a=l===u.X?"X":"O";let c;I()?c=l===u.X?"x":"o":c=l===r.humanPlayer?"x":"o",s.innerHTML=`<span class="piece ${c}">${a}</span>`,s.classList.add("occupied")}n===r.lastMove&&s.classList.add("last-move"),r.gameOver&&s.classList.add("game-over"),r.result&&(r.result.winningIndices.includes(n)&&s.classList.add("win-highlight"),r.result.losingIndices.includes(n)&&s.classList.add("lose-highlight")),e&&o?.has(n)&&s.classList.add(e)})}function M(){if(p.classList.remove("your-turn","x-turn","o-turn","win","lose","draw","x-wins","o-wins"),r.gameOver&&r.result){const{result:t}=r.result;if(t===E.Draw)p.textContent="TIE GAME",p.classList.add("draw");else{const e=t===E.XWins?u.X:u.O;if(I()){const o=e===u.X?"x-wins":"o-wins";r.checkmate?.isCheckmate?p.textContent="CHECKMATE!!":p.textContent=e===u.X?"X WINS!!":"O WINS!!",p.classList.add(o)}else{const o=e===r.humanPlayer;r.checkmate?.isCheckmate?(p.textContent="CHECKMATE!!",p.classList.add(o?"win":"lose")):o?(p.textContent="YOU WIN!!",p.classList.add("win")):(p.textContent="GAME OVER",p.classList.add("lose"))}}}else{const t=C(r.board);I()?(p.textContent=t===u.X?"X PLAYS":"O PLAYS",p.classList.add(t===u.X?"x-turn":"o-turn")):t===r.humanPlayer?(p.textContent="YOUR TURN",p.classList.add("your-turn")):p.textContent=""}}function F(){const t=mt.querySelectorAll(".person-icon");t.length>=2&&t[1].classList.toggle("dim",!r.twoPlayer),K.textContent=r.humanPlayer===u.X?"X":"O",K.classList.toggle("disabled",I());const o=D.indexOf(r.difficulty)+1;z.querySelectorAll(".star").forEach((n,s)=>{n.classList.toggle("dim",s>=o)}),z.classList.toggle("disabled",I())}function k(){r.board=lt(),r.gameOver=!1,r.lastMove=null,r.result=null,r.checkmate=null,Dt(),x(),M(),!I()&&r.humanPlayer===u.O&&setTimeout(()=>wt(),Wt)}function Rt(t){if(r.gameOver)return;const e=C(r.board);!I()&&e!==r.humanPlayer||r.board[t]===u.Empty&&Yt(t)}function Yt(t){const e=C(r.board);r.board=ct(r.board,t),r.lastMove=t;const o=at(r.board,t);if(o.result!==E.Ongoing){r.gameOver=!0,r.result=o,I()?rt(o.result):H(o.result,r.humanPlayer),x(),M();return}const i=e===u.X?u.O:u.X,n=ht(r.board,i);if(n.isCheckmate){r.gameOver=!0,r.checkmate=n;const s=e===u.X?E.XWins:E.OWins;r.result={result:s,winningIndices:[],losingIndices:[],losingPlayer:i},I()?rt(s):H(s,r.humanPlayer),x(),M();return}x(),M(),I()||setTimeout(()=>wt(),Tt)}async function wt(){if(r.gameOver)return;const t=R(r.board);if(t.length===0)return;let e;try{ft()?e=Et(r.board,C(r.board)):e=(await At(r.board,r.difficulty)).move}catch(n){console.error("AI move calculation failed, using random:",n),e=t[Math.floor(Math.random()*t.length)]}r.board=ct(r.board,e),r.lastMove=e;const o=at(r.board,e);if(o.result!==E.Ongoing){r.gameOver=!0,r.result=o,H(o.result,r.humanPlayer),x(),M();return}const i=ht(r.board,r.humanPlayer);if(i.isCheckmate){r.gameOver=!0,r.checkmate=i;const n=r.humanPlayer===u.X?E.OWins:E.XWins;r.result={result:n,winningIndices:[],losingIndices:[],losingPlayer:r.humanPlayer},H(n,r.humanPlayer)}x(),M()}function $t(){mt.addEventListener("click",()=>{r.twoPlayer=!r.twoPlayer,r.twoPlayer&&(A={x:0,o:0}),F(),Y(),k()}),K.addEventListener("click",()=>{I()||(r.humanPlayer=r.humanPlayer===u.X?u.O:u.X,F(),k())}),z.addEventListener("click",()=>{if(I())return;const e=(D.indexOf(r.difficulty)+1)%D.length;r.difficulty=D[e],F(),k()}),Ft.addEventListener("click",()=>{k()})}function j(){const t=window.innerWidth,e=window.innerHeight,o=Math.min(t/st,e/it),i=document.getElementById("app");i.style.transform=`scale(${o})`,i.style.transformOrigin="top center",i.style.width=`${st}px`,i.style.height=`${it}px`}async function Ut(){if(j(),window.addEventListener("resize",j),window.addEventListener("orientationchange",()=>{setTimeout(j,100)}),Ht(),$t(),F(),Y(),ft())V.classList.add("hidden"),k();else try{await Pt("./weights.json"),V.classList.add("hidden"),k()}catch(t){console.error("Failed to load model:",t);const e=V.querySelector(".loading-text");e.textContent="FAILED TO LOAD AI",t instanceof Error&&console.error("Error details:",t.message)}}Ut();
